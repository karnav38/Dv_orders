<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Vision — Order Management</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    .error-box { background:#fee2e2; border:1px solid #ef4444; color:#7f1d1d; padding:12px; border-radius:8px; }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div id="root" class="max-w-6xl mx-auto p-4">
    <!-- Fallback text in case JS fails hard -->
    <div class="text-neutral-500">Loading app…</div>
  </div>

  <script>
  (function () {
    // Show any runtime error on the page instead of blank screen
    function showError(msg) {
      const root = document.getElementById('root');
      var box = document.createElement('div');
      box.className = 'error-box mt-4';
      box.textContent = 'Error: ' + msg;
      root.prepend(box);
      console.error(msg);
    }

    try {
      const { useState, useEffect, useMemo } = React;

      var WEBHOOK = "https://script.google.com/macros/s/AKfycbxl5E7FoByEitlZ2gjQGXp5ATEghw-JgiuSACBui1eToOQfb98dU4efXhoFeGbwGBeUwA/exec";
      var currencies = ["INR","USD","EUR"];

      function emptyAttribute(){ return { name:"", value:"" }; }
      function emptyItem(){ return { productName:"", attributes:[emptyAttribute()], options:"", qty:1, price:0 }; }

      function App(){
        var _useState = useState([]), orders = _useState[0], setOrders = _useState[1];
        var _useState2 = useState(false), loading = _useState2[0], setLoading = _useState2[1];
        var _useState3 = useState("(auto)"), nextId = _useState3[0], setNextId = _useState3[1];

        var _useState4 = useState({
          orderId:"(auto)", customerName:"", crmName:"", designerName:"",
          companyName:"DigitalVision",
          orderDate:(new Date()).toISOString().slice(0,10),
          deliveryDate:(new Date()).toISOString().slice(0,10),
          paymentStatus:"UNPAID", currency:"INR"
        }), meta = _useState4[0], setMeta = _useState4[1];

        var _useState5 = useState([emptyItem()]), items = _useState5[0], setItems = _useState5[1];
        var _useState6 = useState(0), advance = _useState6[0], setAdvance = _useState6[1];
        var _useState7 = useState(""), remarks = _useState7[0], setRemarks = _useState7[1];
        var _useState8 = useState(0), taxRate = _useState8[0], setTaxRate = _useState8[1];

        var subtotal = useMemo(function(){
          var s=0, i;
          for(i=0;i<items.length;i++){ s += (Number(items[i].qty)||0) * (Number(items[i].price)||0); }
          return s;
        }, [items]);

        var taxAmount = useMemo(function(){ return subtotal * (Number(taxRate)||0) / 100; }, [subtotal, taxRate]);
        var grandTotal = subtotal + taxAmount;
        var totalPayable = Math.max(0, grandTotal - (Number(advance)||0));
        function toCurrency(n){ try{ return new Intl.NumberFormat(undefined,{style:"currency",currency:meta.currency||"INR"}).format(n||0);}catch(e){return n;} }

        function updateItem(i,patch){
          setItems(function(prev){
            var out = prev.slice();
            out[i] = Object.assign({}, out[i], patch);
            return out;
          });
        }
        function addItem(){ setItems(function(prev){ return prev.concat([emptyItem()]); }); }
        function removeItem(i){ setItems(function(prev){ return prev.filter(function(_,idx){ return idx!==i; }); }); }
        function addAttr(i){
          setItems(function(prev){
            var out = prev.slice(); var it = Object.assign({}, out[i]);
            it.attributes = it.attributes.concat([emptyAttribute()]);
            out[i] = it; return out;
          });
        }
        function updAttr(i,j,patch){
          setItems(function(prev){
            var out = prev.slice(); var it = Object.assign({}, out[i]);
            var attrs = it.attributes.slice();
            attrs[j] = Object.assign({}, attrs[j], patch);
            it.attributes = attrs; out[i] = it; return out;
          });
        }
        function rmAttr(i,j){
          setItems(function(prev){
            var out = prev.slice(); var it = Object.assign({}, out[i]);
            it.attributes = it.attributes.filter(function(_,k){ return k!==j; });
            out[i] = it; return out;
          });
        }

        function safeJson(res){ return res.json()["catch"] ? res.json() : Promise.resolve(res.json()); }

        function fetchPending(){
          return fetch(WEBHOOK + "?action=list")
            .then(function(r){ return r.json(); })
            .then(function(d){
              if (d && d.ok) setOrders(d.rows||[]);
            })["catch"](function(err){ showError('Fetching pending: ' + err); });
        }
        function fetchPeek(){
          return fetch(WEBHOOK + "?action=peek")
            .then(function(r){ return r.json(); })
            .then(function(d){
              if (d && d.ok && d.nextId) setNextId(d.nextId);
            })["catch"](function(err){ showError('Fetching next ID: ' + err); });
        }
        function updateStatus(orderId, status){
          return fetch(WEBHOOK + "?action=updateStatus", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ orderId: orderId, paymentStatus: status })
          }).then(function(){ fetchPending(); fetchPeek(); })["catch"](function(err){ showError('Update status: ' + err); });
        }
        function saveOrder(){
          var payload = { meta:meta, items:items, totals:{ subtotal:subtotal, taxAmount:taxAmount, grandTotal:grandTotal, advance:advance, totalPayable:totalPayable }, remarks:remarks };
          setLoading(true);
          fetch(WEBHOOK + "?action=save", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          })
          .then(function(r){ return r.json(); })
          .then(function(d){
            if (d && d.ok && d.orderId) setMeta(function(m){ var x=Object.assign({},m); x.orderId=d.orderId; return x; });
            fetchPending(); fetchPeek();
            setItems([emptyItem()]); setAdvance(0); setRemarks(""); setTaxRate(0);
            setMeta(function(m){
              return Object.assign({}, m, {
                orderId:"(auto)", customerName:"", crmName:"", designerName:"",
                orderDate:(new Date()).toISOString().slice(0,10),
                deliveryDate:(new Date()).toISOString().slice(0,10),
                paymentStatus:"UNPAID"
              });
            });
          })
          ["catch"](function(err){ showError('Save order: ' + err); })
          .finally(function(){ setLoading(false); });
        }

        useEffect(function(){ fetchPending(); fetchPeek(); }, []);

        return React.createElement("div", {className:"space-y-6"},
          React.createElement("header",{className:"sticky top-0 z-50 backdrop-blur bg-white/90 border-b -mx-4 px-4"},
            React.createElement("div",{className:"max-w-6xl mx-auto py-3 flex items-center justify-between"},
              React.createElement("h1",{className:"text-2xl sm:text-3xl font-semibold"},"Digital Vision — Order Management"),
              React.createElement("div",{className:"flex gap-2"},
                React.createElement("button",{className:"px-3 py-2 rounded-xl border bg-white", onClick:function(){ fetchPending(); fetchPeek(); }},"Refresh"),
                React.createElement("button",{className:"px-3 py-2 rounded-xl bg-black text-white", onClick:saveOrder, disabled:loading}, loading?"Saving…":"Save Order")
              )
            )
          ),

          // Summary: only Next Order #
          React.createElement("section",null,
            React.createElement(Card,{title:"Next Order #", value: nextId})
          ),

          // Meta
          React.createElement("section",{className:"bg-white rounded-2xl shadow p-4 grid md:grid-cols-4 sm:grid-cols-2 grid-cols-1 gap-4"},
            React.createElement(StaticField,{label:"Order ID (auto)"},
              meta.orderId!=="(auto)" ? meta.orderId : nextId
            ),
            React.createElement(LabeledInput,{label:"Customer Name", value:meta.customerName, onChange:function(v){ setMeta(Object.assign({},meta,{customerName:v})); }}),
            React.createElement(LabeledInput,{label:"CRM Name", value:meta.crmName, onChange:function(v){ setMeta(Object.assign({},meta,{crmName:v})); }}),
            React.createElement(LabeledInput,{label:"Designer Name", value:meta.designerName, onChange:function(v){ setMeta(Object.assign({},meta,{designerName:v})); }}),
            React.createElement(LabeledSelect,{label:"Payment Status", value:meta.paymentStatus, options:["UNPAID","PAID","PARTIAL"], onChange:function(v){ setMeta(Object.assign({},meta,{paymentStatus:v})); }}),
            React.createElement(LabeledSelect,{label:"Currency", value:meta.currency, options:currencies, onChange:function(v){ setMeta(Object.assign({},meta,{currency:v})); }}),
            React.createElement(LabeledInput,{type:"date", label:"Order Date", value:meta.orderDate, onChange:function(v){ setMeta(Object.assign({},meta,{orderDate:v})); }}),
            React.createElement(LabeledInput,{type:"date", label:"Delivery Date", value:meta.deliveryDate, onChange:function(v){ setMeta(Object.assign({},meta,{deliveryDate:v})); }})
          ),

          // Items
          React.createElement("section",{className:"bg-white rounded-2xl shadow p-4"},
            React.createElement("div",{className:"flex items-center justify-between mb-4"},
              React.createElement("h2",{className:"text-lg font-semibold"},"Billing Details"),
              React.createElement("button",{className:"px-3 py-2 rounded-xl bg-black text-white", onClick:addItem},"+ Add Item")
            ),
            items.map(function(it, idx){
              return React.createElement("div",{key:idx, className:"rounded-xl border p-4 mb-4"},
                React.createElement("div",{className:"grid md:grid-cols-4 gap-3"},
                  React.createElement(LabeledInput,{label:"Product Name", value:it.productName, onChange:function(v){ updateItem(idx,{productName:v}); }}),
                  React.createElement(LabeledInput,{label:"Options", value:it.options, onChange:function(v){ updateItem(idx,{options:v}); }}),
                  React.createElement(LabeledInput,{type:"number", label:"Qty", value:it.qty, onChange:function(v){ updateItem(idx,{qty:Number(v)}); }}),
                  React.createElement(LabeledInput,{type:"number", label:"Price", value:it.price, onChange:function(v){ updateItem(idx,{price:Number(v)}); }})
                ),
                React.createElement("button",{className:"mt-2 px-2 py-1 border rounded", onClick:function(){ removeItem(idx); }},"Remove"),
                it.attributes.map(function(a,j){
                  return React.createElement("div",{key:j, className:"grid md:grid-cols-3 gap-3 mt-2"},
                    React.createElement(LabeledInput,{label:"Name", value:a.name, onChange:function(v){ updAttr(idx,j,{name:v}); }}),
                    React.createElement(LabeledInput,{label:"Value", value:a.value, onChange:function(v){ updAttr(idx,j,{value:v}); }}),
                    React.createElement("button",{className:"px-2 py-1 border rounded", onClick:function(){ rmAttr(idx,j); }},"Remove")
                  );
                }),
                React.createElement("button",{className:"mt-2 px-2 py-1 border rounded", onClick:function(){ addAttr(idx); }},"+ Add Attribute")
              );
            })
          ),

          // Totals
          React.createElement("section",{className:"bg-white rounded-2xl shadow p-4 grid md:grid-cols-3 gap-6"},
            React.createElement("div",{className:"md:col-span-2"},
              React.createElement("label",{className:"block text-sm font-medium mb-1"},"Manual Remarks"),
              React.createElement("textarea",{rows:6, value:remarks, onChange:function(e){ setRemarks(e.target.value); }, className:"w-full rounded-xl border px-3 py-2"})
            ),
            React.createElement("div",{className:"md:col-span-1"},
              React.createElement("div",{className:"rounded-xl border p-4 space-y-2 bg-neutral-50"},
                React.createElement(Row,{label:"Subtotal", value:toCurrency(subtotal)}),
                React.createElement("div",{className:"flex items-center justify-between text-sm"},
                  React.createElement("div",{className:"text-neutral-600"},"Other Tax (%)"),
                  React.createElement("input",{type:"number", value:taxRate, onChange:function(e){ setTaxRate(Number(e.target.value)); }, className:"w-20 text-right rounded-lg border px-2 py-1"})
                ),
                React.createElement(Row,{label:"Other Tax Amount", value:toCurrency(taxAmount)}),
                React.createElement("div",{className:"border-t my-2"}),
                React.createElement(Row,{label:"Total", value:toCurrency(grandTotal), emphasize:true}),
                React.createElement(LabeledInput,{type:"number", label:"Advance Payment", value:advance, onChange:function(v){ setAdvance(Number(v)); }}),
                React.createElement(Row,{label:"Total Payable", value:toCurrency(totalPayable), emphasize:true})
              )
            )
          ),

          // Pending
          React.createElement("section",{className:"bg-white rounded-2xl shadow p-4"},
            React.createElement("h2",{className:"text-lg font-semibold mb-4"},"Pending Orders"),
            orders.length===0
              ? React.createElement("div",{className:"text-neutral-500 text-sm"},"No pending orders")
              : orders.map(function(o,i){
                  return React.createElement("div",{key:i, className:"rounded-lg border p-3 flex items-center justify-between mb-2"},
                    React.createElement("div",null,
                      React.createElement("div",{className:"font-semibold"}, (o.orderId||"") + " — " + (o.customerName||"(no name)")),
                      React.createElement("div",{className:"text-sm text-neutral-600"}, "Total: " + toCurrency(o.grandTotal) + " • Payable: " + toCurrency(o.totalPayable))
                    ),
                    React.createElement("div",{className:"flex items-center gap-2 text-sm"},
                      React.createElement("span",{className:"px-2 py-1 rounded-full border"}, o.paymentStatus || ""),
                      (o.paymentStatus!=="PAID") && React.createElement("button",{className:"px-2 py-1 rounded-lg border", onClick:function(){ updateStatus(o.orderId,"PAID"); }},"Mark Paid")
                    )
                  );
                })
          )
        );
      }

      // Small UI helpers
      function Card(props){
        return React.createElement("div",{className:"rounded-xl border p-4 bg-white"},
          React.createElement("div",{className:"text-sm text-neutral-500"}, props.title),
          React.createElement("div",{className:"text-2xl font-semibold"}, props.value)
        );
      }
      function LabeledInput(props){
        return React.createElement("label",{className:"block"},
          React.createElement("span",{className:"block text-sm font-medium mb-1"}, props.label),
          React.createElement("input",{type:props.type||"text", value:props.value, onChange:function(e){ props.onChange(e.target.value); }, className:"w-full rounded-xl border px-3 py-2"})
        );
      }
      function LabeledSelect(props){
        return React.createElement("label",{className:"block"},
          React.createElement("span",{className:"block text-sm font-medium mb-1"}, props.label),
          React.createElement("select",{value:props.value, onChange:function(e){ props.onChange(e.target.value); }, className:"w-full rounded-xl border px-3 py-2 bg-white"},
            props.options.map(function(opt){ return React.createElement("option",{key:opt, value:opt}, opt); })
          )
        );
      }
      function StaticField(props){
        return React.createElement("label",{className:"block"},
          React.createElement("span",{className:"block text-sm font-medium mb-1"}, props.label),
          React.createElement("div",{className:"w-full rounded-xl border px-3 py-2 bg-neutral-100 text-neutral-800"}, props.children || "-")
        );
      }
      function Row(props){
        return React.createElement("div",{className:"flex items-center justify-between " + (props.emphasize?"font-semibold":"text-sm")},
          React.createElement("div",{className:"text-neutral-600"}, props.label),
          React.createElement("div",null, props.value)
        );
      }

      // Mount
      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    } catch (err) {
      showError(err && err.message ? err.message : String(err));
    }
  })();
  </script>
</body>
</html>
